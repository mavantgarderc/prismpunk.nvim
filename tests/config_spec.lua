local config = require("prismpunk.config")

describe("config.parse_theme", function()
  describe("string input - 3 parts", function()
    it("parses fully qualified theme: dc/lantern-corps/green", function()
      local result = config.parse_theme("dc/lantern-corps/green")
      assert.are.equal("dc/lantern-corps", result.universe)
      assert.are.equal("green", result.name)
      assert.are.same({ { universe = "dc/lantern-corps", name = "green" } }, result.variants)
    end)

    it("parses 3-part theme with different parent", function()
      local result = config.parse_theme("marvel/avengers/iron-man")
      assert.are.equal("marvel/avengers", result.universe)
      assert.are.equal("iron-man", result.name)
    end)
  end)

  describe("string input - 2 parts with known parent", function()
    it("parses lantern-corps/green (DC subcategory)", function()
      local result = config.parse_theme("lantern-corps/green")
      assert.are.equal("dc/lantern-corps", result.universe)
      assert.are.equal("green", result.name)
    end)

    it("parses justice-league/superman (DC subcategory)", function()
      local result = config.parse_theme("justice-league/superman")
      assert.are.equal("dc/justice-league", result.universe)
      assert.are.equal("superman", result.name)
    end)

    it("parses bat-family/batman (DC subcategory)", function()
      local result = config.parse_theme("bat-family/batman")
      assert.are.equal("dc/bat-family", result.universe)
      assert.are.equal("batman", result.name)
    end)

    it("parses injustice-league/joker (DC subcategory)", function()
      local result = config.parse_theme("injustice-league/joker")
      assert.are.equal("dc/injustice-league", result.universe)
      assert.are.equal("joker", result.name)
    end)

    it("parses watchmen/rorschach (DC subcategory)", function()
      local result = config.parse_theme("watchmen/rorschach")
      assert.are.equal("dc/watchmen", result.universe)
      assert.are.equal("rorschach", result.name)
    end)
  end)

  describe("string input - 2 parts without known parent", function()
    it("parses kanagawa/paper-edo (direct universe)", function()
      local result = config.parse_theme("kanagawa/paper-edo")
      assert.are.equal("kanagawa", result.universe)
      assert.are.equal("paper-edo", result.name)
      assert.is_true(#result.variants >= 1)
      assert.are.equal("kanagawa", result.variants[1].universe)
    end)

    it("parses tmnt/leonardo (direct universe)", function()
      local result = config.parse_theme("tmnt/leonardo")
      assert.are.equal("tmnt", result.universe)
      assert.are.equal("leonardo", result.name)
    end)

    it("generates discovery variants for unknown category", function()
      local result = config.parse_theme("new-universe/some-theme")
      assert.are.equal("new-universe", result.universe)
      assert.are.equal("some-theme", result.name)
      assert.is_true(#result.variants >= 1)
    end)
  end)

  describe("string input - single part", function()
    it("parses single name without universe", function()
      local result = config.parse_theme("paper-edo")
      assert.is_nil(result.universe)
      assert.are.equal("paper-edo", result.name)
      assert.are.same({}, result.variants)
    end)
  end)

  describe("edge cases - string input", function()
    it("handles empty string", function()
      local result = config.parse_theme("")
      assert.is_nil(result.universe)
      assert.is_nil(result.name)
      assert.are.same({}, result.variants)
    end)

    it("handles nil", function()
      local result = config.parse_theme(nil)
      assert.is_nil(result.universe)
      assert.is_nil(result.name)
      assert.are.same({}, result.variants)
    end)
  end)

  describe("table input", function()
    it("accepts { universe, name } format", function()
      local result = config.parse_theme({ universe = "dc/lantern-corps", name = "green" })
      assert.are.equal("dc/lantern-corps", result.universe)
      assert.are.equal("green", result.name)
    end)

    it("accepts { 'theme-name' } shorthand", function()
      local result = config.parse_theme({ "single-theme" })
      assert.are.equal("single-theme", result.name)
    end)

    it("accepts opts field", function()
      local result = config.parse_theme({ universe = "kanagawa", name = "paper-edo", opts = { gutter = false } })
      assert.are.equal("kanagawa", result.universe)
      assert.are.equal("paper-edo", result.name)
      assert.are.same({ gutter = false }, result.opts)
    end)

    it("uses name field over index", function()
      local result = config.parse_theme({ name = "preferred", [1] = "ignored" })
      assert.are.equal("preferred", result.name)
    end)
  end)

  describe("error handling", function()
    it("errors on invalid type (number)", function()
      assert.has_error(function()
        config.parse_theme(123)
      end, "[prismpunk] Invalid theme_spec type: number (expected string or table)")
    end)

    it("errors on invalid type (boolean)", function()
      assert.has_error(function()
        config.parse_theme(true)
      end, "[prismpunk] Invalid theme_spec type: boolean (expected string or table)")
    end)
  end)
end)

describe("config.setup", function()
  it("merges user config with defaults", function()
    local result = config.setup({ theme = "kanagawa/paper-edo", gutter = false })
    assert.are.equal("kanagawa/paper-edo", result.theme)
    assert.is_false(result.gutter)
    assert.is_table(result.styles)
    assert.is_table(result.terminals)
  end)

  it("returns defaults when no config provided", function()
    local result = config.setup()
    assert.is_table(result.styles)
    assert.is_table(result.terminals)
    assert.is_table(result.cache)
  end)

  it("validates config schema", function()
    assert.has_error(function()
      config.setup({ gutter = "not a boolean" })
    end)
  end)

  it("warns on unknown keys", function()
    local warned = false
    local orig_notify = vim.notify
    vim.notify = function(msg) -- luacheck: ignore
      if msg:match("Unknown config key") then warned = true end
    end
    config.setup({ unknown_key = "value" })
    vim.notify = orig_notify -- luacheck: ignore
    assert.is_true(warned)
  end)
end)

describe("config.defaults", function()
  it("has required default values", function()
    assert.is_table(config.defaults.styles)
    assert.is_table(config.defaults.terminals)
    assert.is_table(config.defaults.cache)
    assert.is_table(config.defaults.overrides)
  end)

  it("has style subcategories", function()
    assert.is_table(config.defaults.styles.comments)
    assert.is_table(config.defaults.styles.keywords)
    assert.is_table(config.defaults.styles.diagnostics)
    assert.is_table(config.defaults.styles.git)
    assert.is_table(config.defaults.styles.ui)
  end)

  it("has terminal defaults", function()
    assert.is_boolean(config.defaults.terminals.enabled)
    assert.is_boolean(config.defaults.terminals.auto_detect)
  end)

  it("has cache defaults", function()
    assert.is_boolean(config.defaults.cache.enable)
    assert.is_boolean(config.defaults.cache.persist_to_disk)
  end)

  it("has default theme set", function()
    assert.is_string(config.defaults.theme)
    assert.is_true(#config.defaults.theme > 0)
  end)
end)

describe("config.DEFAULT_THEME", function()
  it("exports default theme constant", function()
    assert.is_string(config.DEFAULT_THEME)
    assert.is_true(#config.DEFAULT_THEME > 0)
  end)

  it("matches defaults.theme", function()
    assert.equal(config.DEFAULT_THEME, config.defaults.theme)
  end)
end)
